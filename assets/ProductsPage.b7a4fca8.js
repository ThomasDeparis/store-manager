import{Q as O}from"./QPage.b8968cdc.js";import{d as M}from"./QItem.d689a8ba.js";import{ai as H,d as C,c as q,r as p,_ as R,H as $,R as B,j as l,J as s,O as y,aj as m,Q as K,P as b,G as g,I as U,ak as J,al as W,am as X,K as Y,F as Z}from"./index.84a3eb74.js";import{E as v,Q as _,a as x,b as ee,c as S,d as re,S as F}from"./SidePanel.5b9f3d2f.js";import{c as w,q as N,w as E,g as D,d as z,a as h,s as oe,b as le,u as I}from"./user-store.6dc92048.js";import{u as j}from"./vue-i18n.runtime.6dcd973d.js";import{Q as G,u as te}from"./notify-handler.22fa8327.js";import{t as k}from"./index.8b0188d9.js";var T=(e=>(e[e.ReferenceExists=0]="ReferenceExists",e))(T||{});const Q=H("product",{state:()=>({products:[],error:null,isLoading:!1}),actions:{async loadProducts(e){this.isLoading=!0;const r=w(h,"products"),t=N(r,E("storeId","==",e)),a=await D(t);this.products=a.docs.map(function(n){return{id:n.id,name:n.data().name,quantity:n.data().quantity,sellPrice:n.data().sellPrice,reference:n.data().reference,providerReference:n.data().providerReference,storeId:n.data().storeId,lastChangeUserId:n.data().lastChangeUserId}}),this.isLoading=!1},async referenceExists(e,r){const t=w(h,"products"),a=N(t,E("storeId","==",e),E("reference","==",r));return!(await D(a)).empty},async addProduct(e){if(await this.referenceExists(e.storeId,e.reference))throw{messageKey:T.ReferenceExists,productReference:e.reference,errorType:v.Business};try{const t=z(w(h,"products"));e.id=t.id,await oe(t,e),this.products.push(e)}catch(t){throw{productReference:e.reference,errorType:v.Technical,message:t.toString()}}},async editProduct(e){try{const r=z(w(h,"products"),e.id);await le(r,{name:e.name,providerReference:e.providerReference,sellPrice:e.sellPrice,lastChangeUserId:e.lastChangeUserId});const t=this.products.findIndex(n=>n.id===e.id&&n.storeId===e.storeId);if(t<0)throw{productReference:e.reference,errorType:v.Technical,message:"productStore.editProduct : cannot find product in store to edit it"};console.log(e),console.log(e.sellPrice);const a=this.products[t];a.name=e.name,a.providerReference=e.providerReference,a.sellPrice=e.sellPrice,a.lastChangeUserId=e.lastChangeUserId}catch(r){throw{productReference:e.reference,errorType:v.Technical,message:r.toString()}}}}}),ne=C({name:"ProductGrid",emits:["new-product-click","edit-row-click","detail-row-click"],setup(){const{t:e}=j(),r=Q(),t=I(),a=[{name:"actions",label:"",align:"center"},{name:"reference",label:e("product.reference"),field:"reference",sortable:!0},{name:"providerreference",label:e("product.providerRef"),field:"providerReference",sortable:!0},{name:"name",label:e("product.name"),field:"name",sortable:!0},{name:"quantity",label:e("product.quantity"),field:"quantity",sortable:!0},{name:"sellprice",label:e("product.sellPrice"),field:"sellPrice",format:d=>`${d} \u20AC`}],n=()=>{r.loadProducts(t.currentStore)},i=q(()=>r.products.map(function(d){return{...d,actions:null}}));return{filter:p(""),columns:a,rows:i,loadProducts:n,loading:r.isLoading}}}),ae={class:"q-pa-md"},de=b("div",{class:"text-body2"},"\xC9diter",-1),se=b("div",{class:"text-body2"},"D\xE9tail",-1),ie=b("div",{class:"text-body2"},"Dupliquer",-1);function ue(e,r,t,a,n,i){return $(),B("div",ae,[l(re,{"grid-header":"",bordered:"",rows:e.rows,columns:e.columns,"row-key":"reference",filter:e.filter,"rows-per-page-options":[50,100]},{top:s(()=>[l(y,{color:"primary",label:e.$t("product.newProduct"),onClick:r[0]||(r[0]=d=>e.$emit("new-product-click"))},null,8,["label"]),l(_),l(m,{dense:"",debounce:"300",color:"primary",modelValue:e.filter,"onUpdate:modelValue":r[1]||(r[1]=d=>e.filter=d)},{append:s(()=>[l(K,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-actions":s(d=>[l(x,{props:d},{default:s(()=>[l(ee),l(y,{class:"q-mr-sm",icon:"edit",push:"",round:"",color:"amber-7",size:"sm",onClick:o=>e.$emit("edit-row-click",d.row)},{default:s(()=>[l(S,null,{default:s(()=>[de]),_:1})]),_:2},1032,["onClick"]),l(y,{icon:"visibility",class:"q-mr-sm",push:"",round:"",color:"primary",size:"sm",onClick:o=>e.$emit("detail-row-click",d.row)},{default:s(()=>[l(S,null,{default:s(()=>[se]),_:1})]),_:2},1032,["onClick"]),l(y,{icon:"copy_all",round:"",push:"",color:"grey",size:"sm"},{default:s(()=>[l(S,null,{default:s(()=>[ie]),_:1})]),_:1})]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"]),l(y,{icon:"search",onClick:e.loadProducts},null,8,["onClick"])])}var ce=R(ne,[["render",ue]]);const me=C({name:"ProductCreation",emits:["close","product-created","product-creation-failed"],components:{SidePanel:F},setup(e,r){const t=p(),a=p(""),n=p(""),i=p(0),d=p(""),o=Q(),f=I(),c=()=>{var P;a.value="",n.value="",i.value=0,d.value="",(P=t.value)==null||P.resetValidation()};return{form:t,reference:a,providerReference:n,sellPrice:i,name:d,onSubmit:async()=>{var P;try{const u={reference:a.value,providerReference:n.value,sellPrice:i.value,name:d.value,quantity:0,storeId:f.currentStore,lastChangeUserId:(P=f.userData)==null?void 0:P.uid},V=await o.addProduct(u);r.emit("product-created",V),c()}catch(u){r.emit("product-creation-failed",u)}}}}}),pe={class:"row justify-center"};function fe(e,r,t,a,n,i){const d=g("side-panel");return $(),U(d,{title:e.$t("product.newProduct"),onClose:r[4]||(r[4]=o=>e.$emit("close"))},{default:s(()=>[l(G,{onSubmit:e.onSubmit,ref:"form",class:"q-gutter-md q-pa-sm"},{default:s(()=>[l(m,{filled:"",modelValue:e.reference,"onUpdate:modelValue":r[0]||(r[0]=o=>e.reference=o),label:e.$t("product.reference"),"lazy-rules":"",rules:[o=>o&&o.length>0||e.$t("forms.mandatory")]},null,8,["modelValue","label","rules"]),l(m,{filled:"",modelValue:e.providerReference,"onUpdate:modelValue":r[1]||(r[1]=o=>e.providerReference=o),label:e.$t("product.providerReference")},null,8,["modelValue","label"]),l(m,{filled:"",modelValue:e.name,"onUpdate:modelValue":r[2]||(r[2]=o=>e.name=o),label:e.$t("product.name"),"lazy-rules":"",rules:[o=>o&&o.length>0||e.$t("forms.mandatory")]},null,8,["modelValue","label","rules"]),l(m,{filled:"",suffix:"\u20AC",mask:"#.##","fill-mask":"0","reverse-fill-mask":"",modelValue:e.sellPrice,"onUpdate:modelValue":r[3]||(r[3]=o=>e.sellPrice=o),"input-class":"text-right",label:e.$t("product.sellPrice"),"lazy-rules":"",rules:[o=>o!==null&&o!==""&&o>0||e.$t("product.enterValidSellPrice")]},null,8,["modelValue","label","rules"]),b("div",pe,[l(y,{label:e.$t("buttons.create"),type:"submit",color:"primary"},null,8,["label"])])]),_:1},8,["onSubmit"])]),_:1},8,["title"])}var ye=R(me,[["render",fe]]);const Pe=C({name:"ProductEdit",props:{readonlyMode:{type:Boolean,default:!1},modelValue:{type:Object,required:!0}},emits:["close","update:modelValue","update:readonlyMode","product-edit-failed"],components:{SidePanel:F},setup(e,r){const t=q(()=>e.modelValue),a=J(e.readonlyMode);W(()=>a.value=e.readonlyMode);const n=Q(),i=I();return{editing:t,isReadonly:a,onSubmit:async()=>{var o;try{t.value.lastChangeUserId=(o=i.userData)==null?void 0:o.uid,await n.editProduct(t.value),r.emit("update:modelValue",t.value)}catch(f){r.emit("product-edit-failed",f)}}}}}),be={class:"row"},ve={class:"row justify-center"};function ge(e,r,t,a,n,i){const d=g("side-panel");return $(),U(d,{title:e.$t("product.detail"),onClose:r[5]||(r[5]=o=>e.$emit("close"))},{default:s(()=>[b("div",be,[l(X,{class:"","model-value":e.isReadonly,color:"green",label:"mode \xE9dition","true-value":!1,"false-value":!0,"onUpdate:modelValue":r[0]||(r[0]=o=>e.$emit("update:readonlyMode",e.isReadonly))},null,8,["model-value"])]),l(G,{onSubmit:e.onSubmit,ref:"form",class:"q-gutter-md q-pa-sm"},{default:s(()=>[l(m,{filled:"",modelValue:e.editing.reference,"onUpdate:modelValue":r[1]||(r[1]=o=>e.editing.reference=o),label:e.$t("product.reference"),readonly:"","lazy-rules":"",rules:[o=>o&&o.length>0||e.$t("forms.mandatory")]},null,8,["modelValue","label","rules"]),l(m,{filled:"",modelValue:e.editing.providerReference,"onUpdate:modelValue":r[2]||(r[2]=o=>e.editing.providerReference=o),readonly:e.isReadonly,label:e.$t("product.providerReference")},null,8,["modelValue","readonly","label"]),l(m,{filled:"",modelValue:e.editing.name,"onUpdate:modelValue":r[3]||(r[3]=o=>e.editing.name=o),label:e.$t("product.name"),readonly:e.isReadonly,"lazy-rules":"",rules:[o=>o&&o.length>0||e.$t("forms.mandatory")]},null,8,["modelValue","label","readonly","rules"]),l(m,{filled:"",suffix:"\u20AC",mask:"#.##","fill-mask":"0","reverse-fill-mask":"",modelValue:e.editing.sellPrice,"onUpdate:modelValue":r[4]||(r[4]=o=>e.editing.sellPrice=o),"input-class":"text-right",label:e.$t("product.sellPrice"),readonly:e.isReadonly,"lazy-rules":"",rules:[o=>o!==null&&o!==""&&o>0||e.$t("product.enterValidSellPrice")]},null,8,["modelValue","label","readonly","rules"]),b("div",ve,[e.isReadonly?Y("",!0):($(),U(y,{key:0,label:e.$t("buttons.edit"),type:"submit",color:"primary"},null,8,["label"]))])]),_:1},8,["onSubmit"])]),_:1},8,["title"])}var $e=R(Pe,[["render",ge]]);function we(e){return e.errorType===v.Technical?(console.log(e),k("common.technicalError")):(e==null?void 0:e.messageKey)===T.ReferenceExists?k("product.referenceExists"):k("common.technicalError")}const he=C({name:"ProductsPage",components:{ProductGrid:ce,ProductCreation:ye,ProductEdit:$e},setup(){const{t:e}=j(),r=te(),t={id:"",name:"",quantity:0,sellPrice:0,reference:"",storeId:"",providerReference:"",lastChangeUserId:""},a=p(t);var n=p(null);const i=(u,V)=>{n.value=u;let A=Object.create(V);a.value=A},d=()=>{n.value=null,a.value=t},o=q(()=>n.value==="detail");return{handleTechnicalError:u=>r.NotifyError(we(u)),handleNewProduct:()=>{r.NotifySuccess(e("product.created"))},handleProductEdited:()=>{r.NotifySuccess(e("product.edited")),d()},sidePanel:n,openSidePanel:i,closeSidePanel:d,emptyRow:t,editingRow:a,readonlyEditMode:o,handleEditModeChanged:u=>{console.log("nouveau mode"),console.log(u),n.value=u?"edit":"detail"}}}});function Ce(e,r,t,a,n,i){const d=g("product-grid"),o=g("product-creation"),f=g("product-edit");return $(),B(Z,null,[l(O,null,{default:s(()=>[l(d,{onNewProductClick:r[0]||(r[0]=c=>e.openSidePanel("new",e.emptyRow)),onEditRowClick:r[1]||(r[1]=c=>e.openSidePanel("edit",c)),onDetailRowClick:r[2]||(r[2]=c=>e.openSidePanel("detail",c))})]),_:1}),l(M,{"model-value":e.sidePanel==="new",side:"right",bordered:""},{default:s(()=>[l(o,{onProductCreated:e.handleNewProduct,onProductCreationFailed:e.handleTechnicalError,onClose:e.closeSidePanel},null,8,["onProductCreated","onProductCreationFailed","onClose"])]),_:1},8,["model-value"]),l(M,{"model-value":e.sidePanel==="edit"||e.sidePanel==="detail",side:"right",bordered:""},{default:s(()=>[l(f,{modelValue:e.editingRow,"onUpdate:modelValue":[r[3]||(r[3]=c=>e.editingRow=c),e.handleProductEdited],"readonly-mode":e.readonlyEditMode,onClose:e.closeSidePanel,"onUpdate:readonlyMode":e.handleEditModeChanged,onProductEditFailed:e.handleTechnicalError},null,8,["modelValue","readonly-mode","onClose","onUpdate:modelValue","onUpdate:readonlyMode","onProductEditFailed"])]),_:1},8,["model-value"])],64)}var Te=R(he,[["render",Ce]]);export{Te as default};
