import{Q as M}from"./QPage.8f8fca4a.js";import{Q as j}from"./QDrawer.d057bf3e.js";import{d as S,c as O,w as B,o as L,r as v,_ as h,H as u,R as g,j as n,J as d,O as p,aj as I,Q as U,I as _,K as V,P as b,G as k,L as y,S as F,F as P,M as D,b5 as T,N as z}from"./index.44d67d2d.js";import{Q as A,a as q,S as G}from"./SidePanel.28b22910.js";import{Q as J,a as K}from"./errortype.037c0a40.js";import{u as N,h as E}from"./moment.f2e9c11c.js";import{u as W}from"./user-store.6337866a.js";import{u as Y}from"./vue-i18n.runtime.1ff69fdb.js";import{c as X,b as Z,Q as x,a as w}from"./QItem.a48aadf6.js";import{Q as ee,u as re}from"./notify-handler.b41894ac.js";import{u as oe}from"./use-dialog-plugin-component.b9fca404.js";import"./product-store.06ab63c5.js";const te=S({name:"OrderGrid",emits:["new-order-click","confirm-row-click"],setup(){const{t:e}=Y(),t=N(),a=W(),s=[{name:"actions",label:"",align:"center"},{name:"reference",label:e("order.reference"),field:"reference",sortable:!0},{name:"provider",label:e("provider.name"),field:"providerId"},{name:"orderDate",label:e("order.orderDate"),field:"orderDate",sortable:!0,format:r=>E(r).format("DD/MM/YYYY HH:mm")},{name:"receiptDate",label:e("order.receiptDate"),field:"receiptDate",sortable:!0,format:r=>r?E(r).format("DD/MM/YYYY HH:mm"):""}],l=()=>{var r;(t.orders==null||((r=t.orders)==null?void 0:r.length)===0||t.storeId!==a.currentStore)&&t.loadOrders(a.currentStore)},m=O(()=>t.orders.map(function(r){return{...r,actions:null}}));return B(()=>a.currentStore,()=>{l()}),L(()=>{a.currentStore!=null&&l()}),{filter:v(""),columns:s,rows:m,loadOrders:l,loading:O(()=>t.isLoading)}}}),ne={class:"q-pa-md"},de=b("div",{class:"text-body2"},"Finaliser la commande",-1);function ae(e,t,a,s,l,m){return u(),g("div",ne,[n(K,{"grid-header":"",bordered:"",rows:e.rows,columns:e.columns,"row-key":"reference",filter:e.filter,"rows-per-page-options":[50,100]},{top:d(()=>[n(p,{color:"primary",label:e.$t("order.newOrder"),onClick:t[0]||(t[0]=r=>e.$emit("new-order-click"))},null,8,["label"]),n(A),n(I,{dense:"",debounce:"300",color:"primary",modelValue:e.filter,"onUpdate:modelValue":t[1]||(t[1]=r=>e.filter=r)},{append:d(()=>[n(U,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-actions":d(r=>[n(J,{props:r},{default:d(()=>[r.row.receiptDate===void 0?(u(),_(p,{key:0,class:"q-mr-sm",icon:"check_circle",push:"",round:"",color:"green",size:"sm",onClick:o=>e.$emit("confirm-row-click",r.row)},{default:d(()=>[n(q,null,{default:d(()=>[de]),_:1})]),_:2},1032,["onClick"])):V("",!0)]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"])])}var le=h(te,[["render",ae]]);const se=S({name:"OrderConfirm",components:{SidePanel:G},emits:["order-confirmed","close"],props:{orderReference:{type:String},orderId:{type:String,required:!0},modelValue:{type:Object,required:!0}},setup(e,t){const a=O(()=>e.modelValue),s=N();return{cartContent:a,confirmOrder:async()=>{const r=a.value.map(function(o){return{id:o.id,productId:o.productId,productName:o.productName,productReference:o.productReference,orderedQty:Number(o.orderedQty),receivedQty:Number(o.receivedQty),unitPrice:Number(o.unitPrice)}});await s.validateReceipt(e.orderId,r),t.emit("order-confirmed",a.value)},fillAllQties:()=>{var r;(r=a==null?void 0:a.value)==null||r.forEach(o=>{o.receivedQty=o.orderedQty})}}}}),ie={class:"row justify-center"},ce={class:"col q-pa-md"},me=b("div",{class:"text-body2"},"Quantit\xE9 re\xE7ue conforme",-1);function ue(e,t,a,s,l,m){const r=k("side-panel");return u(),_(r,{title:`R\xE9ception de la commande : ${e.orderReference}`,onClose:t[0]||(t[0]=o=>e.$emit("close"))},{default:d(()=>[n(X,{bordered:"",padding:""},{default:d(()=>[n(ee,{onSubmit:e.confirmOrder},{default:d(()=>[b("div",ie,[n(p,{class:"q-ma-sm",type:"submit",color:"primary"},{default:d(()=>[y("Confirmer r\xE9ception")]),_:1}),n(p,{class:"q-ma-sm",color:"green",onClick:e.fillAllQties},{default:d(()=>[y("R\xE9ception compl\xE8te")]),_:1},8,["onClick"])]),(u(!0),g(P,null,F(e.cartContent,(o,i)=>{var Q;return u(),g("div",{key:o.productId},[n(Z,null,{default:d(()=>[n(x,null,{default:d(()=>[n(w,{overline:""},{default:d(()=>[y(D(o.productReference),1)]),_:2},1024),n(w,null,{default:d(()=>[y(D(o.productName),1)]),_:2},1024),n(w,{class:"row",caption:""},{default:d(()=>[n(I,{class:"q-pa-sm col-8",modelValue:o.receivedQty,"onUpdate:modelValue":c=>o.receivedQty=c,mask:"#","fill-mask":"0",type:"number",label:e.$t("order.receivedQty"),hint:`Quantit\xE9 command\xE9e : ${o.orderedQty}`,dense:"","lazy-rules":"",rules:[c=>c&&c>0||`Quantit\xE9 command\xE9e : ${o.orderedQty}`]},null,8,["modelValue","onUpdate:modelValue","label","hint","rules"]),b("div",ce,[n(p,{class:"",onClick:c=>o.receivedQty=o.orderedQty,round:"",push:"",size:"sm",icon:"assignment_turned_in",color:"green"},{default:d(()=>[n(q,null,{default:d(()=>[me]),_:1})]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024)]),_:2},1024),i<(((Q=e.cartContent)==null?void 0:Q.length)||0)-1?(u(),_(T,{key:0,spaced:""})):V("",!0)])}),128))]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["title"])}var fe=h(se,[["render",ue]]);const pe=S({name:"OrdersPage",components:{OrderGrid:le,OrderConfirm:fe},emits:[...oe.emits],setup(){const{t:e}=Y(),t=z(),a=v(!1),s=N(),l=re(),m=()=>{t.push({name:"neworder"})},r={id:"",providerId:"",reference:"",orderDate:new Date,storeId:"",products:[]},o=v(r);var i=v(null);const Q=(H,f)=>{var R;try{((R=f==null?void 0:f.products)==null?void 0:R.length)===0&&s.loadOrderProducts(f.id),i.value=H;const C=s.orders.find($=>$.id===f.id);if(!C)l.NotifyError(e("common.technicalError"));else{let $=Object.create(C);o.value=$}}catch{l.NotifyError(e("common.technicalError"))}},c=()=>{i.value=null,o.value=r};return{dialogOpened:a,editingRow:o,gotoNewOrder:m,sidePanel:i,openSidePanel:Q,closeSidePanel:c,handleOrderConfirmed:()=>{c(),l.NotifySuccess(e("order.received"))}}}});function Qe(e,t,a,s,l,m){const r=k("order-grid"),o=k("order-confirm");return u(),g(P,null,[n(M,null,{default:d(()=>[n(r,{onNewOrderClick:e.gotoNewOrder,onConfirmRowClick:t[0]||(t[0]=i=>e.openSidePanel("confirm",i))},null,8,["onNewOrderClick"])]),_:1}),n(j,{"model-value":e.sidePanel==="confirm",side:"right",bordered:""},{default:d(()=>[n(o,{"order-id":e.editingRow.id,modelValue:e.editingRow.products,"onUpdate:modelValue":t[1]||(t[1]=i=>e.editingRow.products=i),"order-reference":e.editingRow.reference,onOrderConfirmed:e.handleOrderConfirmed,onClose:e.closeSidePanel},null,8,["order-id","modelValue","order-reference","onOrderConfirmed","onClose"])]),_:1},8,["model-value"])],64)}var Re=h(pe,[["render",Qe]]);export{Re as default};
