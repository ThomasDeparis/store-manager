import{Q as G}from"./QPage.3b99b189.js";import{Q as A}from"./QDrawer.4de285b1.js";import{d as k,c as y,w as J,o as K,r as _,_ as D,H as $,R as C,j as o,J as d,O as w,aj as L,Q as W,I as b,P as v,M as i,K as h,G as O,L as Q,S as M,F as N,b5 as j,N as X}from"./index.18c1dc6c.js";import{Q as Z,a as V,S as U}from"./SidePanel.5da47a04.js";import{Q as x,a as ee}from"./errortype.94012622.js";import{u as I,h as Y,a as re}from"./order-error-handler.78148153.js";import{u as B}from"./provider-store.d8ca3a01.js";import{u as oe}from"./user-store.b5080284.js";import{u as z}from"./vue-i18n.runtime.58a5f66e.js";import{c as H,b as T,Q as F,a as g}from"./QItem.29ea8914.js";import{Q as te,u as de}from"./notify-handler.7b8edc83.js";import{u as ne}from"./customer-store.c8a41400.js";import{u as le}from"./use-dialog-plugin-component.477868ce.js";import"./product-store.f196d173.js";import"./index.4e10e456.js";const se=k({name:"OrderGrid",emits:["new-order-click","confirm-row-click","detail-row-click"],setup(){const{t:e}=z(),r=I(),a=oe(),c=B(),m=[{name:"actions",label:"",align:"center"},{name:"reference",label:e("order.reference"),field:"reference",sortable:!0},{name:"provider",label:e("order.provider"),field:"providerName"},{name:"orderDate",label:e("order.orderDate"),field:"orderDate",sortable:!0,format:t=>Y(t).format("DD/MM/YYYY")},{name:"receiptDate",label:e("order.receiptDate"),field:"receiptDate",sortable:!0,format:t=>t?Y(t).format("DD/MM/YYYY HH:mm"):""}],f=()=>{var t,s;(r.orders==null||((t=r.orders)==null?void 0:t.length)===0||r.storeId!==a.currentStore)&&r.loadOrders(a.currentStore),(c.providers==null||((s=c.providers)==null?void 0:s.length)===0||c.storeId!==a.currentStore)&&c.loadProviders(a.currentStore)},l=y(()=>c.providers),n=y(()=>r.orders.map(function(t){var s;return{...t,providerName:(s=l.value.find(u=>u.id===t.providerId))==null?void 0:s.name,actions:null}}));return J(()=>a.currentStore,()=>{f()}),K(()=>{a.currentStore!=null&&f()}),{filter:_(""),columns:m,rows:n,loadOrders:f,loading:y(()=>r.isLoading)}}}),ae={class:"q-pa-md"},ie={class:"text-body2"},ue={class:"text-body2"};function ce(e,r,a,c,m,f){return $(),C("div",ae,[o(ee,{"grid-header":"",bordered:"",rows:e.rows,columns:e.columns,"row-key":"reference",filter:e.filter,"rows-per-page-options":[50,100]},{top:d(()=>[o(w,{color:"primary",label:e.$t("order.newOrder"),onClick:r[0]||(r[0]=l=>e.$emit("new-order-click"))},null,8,["label"]),o(Z),o(L,{dense:"",debounce:"300",color:"primary",modelValue:e.filter,"onUpdate:modelValue":r[1]||(r[1]=l=>e.filter=l)},{append:d(()=>[o(W,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-actions":d(l=>[o(x,{props:l},{default:d(()=>[l.row.receiptDate===void 0?($(),b(w,{key:0,class:"q-mr-sm",icon:"check_circle",push:"",round:"",color:"green",size:"sm",onClick:n=>e.$emit("confirm-row-click",l.row)},{default:d(()=>[o(V,null,{default:d(()=>[v("div",ie,i(e.$t("order.confirm")),1)]),_:1})]),_:2},1032,["onClick"])):h("",!0),l.row.receiptDate?($(),b(w,{key:1,"data-testid":"detailorderbtn",class:"q-mr-sm",icon:"visibility",push:"",round:"",color:"primary",size:"sm",onClick:n=>e.$emit("detail-row-click",l.row)},{default:d(()=>[o(V,null,{default:d(()=>[v("div",ue,i(e.$t("buttons.detail")),1)]),_:1})]),_:2},1032,["onClick"])):h("",!0)]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"])])}var me=D(se,[["render",ce]]);const fe=k({name:"OrderConfirm",components:{SidePanel:U},emits:["order-confirmed","order-confirm-error","close"],props:{orderReference:{type:String},orderId:{type:String,required:!0},modelValue:{type:Object,required:!0}},setup(e,r){const a=y(()=>e.modelValue),c=I();return{cartContent:a,confirmOrder:async()=>{try{await c.validateReceipt(e.orderId,a.value),r.emit("order-confirmed",a.value)}catch(l){r.emit("order-confirm-error",l)}},fillAllQties:()=>{var l;(l=a==null?void 0:a.value)==null||l.forEach(n=>{n.receivedQty=n.orderedQty})}}}}),pe={class:"row justify-center"},ve={class:"col q-pa-md"},$e=v("div",{class:"text-body2"},"Quantit\xE9 re\xE7ue conforme",-1);function ye(e,r,a,c,m,f){const l=O("side-panel");return $(),b(l,{title:`R\xE9ception de la commande : ${e.orderReference}`,onClose:r[0]||(r[0]=n=>e.$emit("close"))},{default:d(()=>[o(H,{bordered:"",padding:""},{default:d(()=>[o(te,{onSubmit:e.confirmOrder},{default:d(()=>[v("div",pe,[o(w,{class:"q-ma-sm",type:"submit",color:"primary"},{default:d(()=>[Q("Confirmer r\xE9ception")]),_:1}),o(w,{class:"q-ma-sm",color:"green",onClick:e.fillAllQties},{default:d(()=>[Q("R\xE9ception compl\xE8te")]),_:1},8,["onClick"])]),($(!0),C(N,null,M(e.cartContent,(n,t)=>{var s;return $(),C("div",{key:n.productId},[o(T,null,{default:d(()=>[o(F,null,{default:d(()=>[o(g,{overline:""},{default:d(()=>[Q(i(n.productReference),1)]),_:2},1024),o(g,null,{default:d(()=>[Q(i(n.productName),1)]),_:2},1024),o(g,{class:"row",caption:""},{default:d(()=>[o(L,{class:"q-pa-sm col-8",modelValue:n.receivedQty,"onUpdate:modelValue":u=>n.receivedQty=u,modelModifiers:{number:!0},inputmode:"numeric",label:e.$t("order.receivedQty"),hint:`Quantit\xE9 command\xE9e : ${n.orderedQty}`,dense:"","lazy-rules":"",rules:[u=>u>=0||`Quantit\xE9 command\xE9e : ${n.orderedQty}`]},null,8,["modelValue","onUpdate:modelValue","label","hint","rules"]),v("div",ve,[o(w,{class:"",onClick:u=>n.receivedQty=n.orderedQty,round:"",push:"",size:"sm",icon:"assignment_turned_in",color:"green"},{default:d(()=>[o(V,null,{default:d(()=>[$e]),_:1})]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024)]),_:2},1024),t<(((s=e.cartContent)==null?void 0:s.length)||0)-1?($(),b(j,{key:0,spaced:""})):h("",!0)])}),128))]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["title"])}var Qe=D(fe,[["render",ye]]);const ge=k({name:"OrderDetail",components:{SidePanel:U},emits:["close"],props:{modelValue:{type:Object,required:!0}},setup(e){const r=y(()=>e.modelValue),a=y(()=>"providerId"in r.value),c=B(),m=ne(),f=y(()=>{var t,s;if(a.value){const{providerId:u}=r.value;return(t=c.providers.find(p=>p.id===u))==null?void 0:t.name}else{const{customerId:u}=r.value;return(s=m.customers.find(p=>p.id===u))==null?void 0:s.name}}),l=y(()=>{if(a.value){const{receiptDate:t}=r.value;return t}else return r.value.orderDate}),n=y(()=>{var t,s;return(s=(t=r.value)==null?void 0:t.products)==null?void 0:s.reduce((u,p)=>u+p.unitPrice*((p==null?void 0:p.receivedQty)||0),0)});return{order:r,recipientName:f,totalAmount:n,isProviderOrder:a,receiptDate:l}}}),we={class:"q-my-md q-mx-sm"},Ce={class:"q-ma-sm"},be={class:"q-ma-sm"},Se={class:"q-my-md"},Oe={class:"row q-mx-sm"},_e={class:"row q-mx-sm text-caption"};function he(e,r,a,c,m,f){const l=O("side-panel");return $(),b(l,{title:`D\xE9tail de la commande : ${e.order.reference}`,onClose:r[0]||(r[0]=n=>e.$emit("close"))},{default:d(()=>{var n;return[v("div",null,[v("p",we,i(e.$t("order.provider"))+" : "+i(e.recipientName),1),v("p",Ce,i(e.$t("order.orderDate"))+" : "+i(e.order.orderDate.toLocaleDateString()),1),v("p",be,i(e.$t("order.receiptDate"))+" : "+i((n=e.receiptDate)==null?void 0:n.toLocaleDateString()),1)]),v("div",Se,[v("span",Oe,i(e.$t("order.totalAmount"))+" : "+i(e.totalAmount)+" \u20AC",1),v("span",_e,i(e.$t("order.cartContent")),1),o(H,{bordered:"",padding:""},{default:d(()=>[($(!0),C(N,null,M(e.order.products,(t,s)=>{var u,p;return $(),C("div",{key:t.productId},[o(T,null,{default:d(()=>[o(F,null,{default:d(()=>[o(g,{overline:""},{default:d(()=>[Q(i(t.productReference),1)]),_:2},1024),o(g,{class:"q-mb-sm"},{default:d(()=>[Q(i(t.productName),1)]),_:2},1024),o(g,{class:"row"},{default:d(()=>[Q(i(e.$t("order.shortReceivedQty"))+" : "+i(t.receivedQty),1)]),_:2},1024),o(g,{class:"row",caption:""},{default:d(()=>[Q(i(e.$t("order.shortQty"))+" : "+i(t.orderedQty),1)]),_:2},1024),o(g,{class:"row"},{default:d(()=>[Q(i(e.$t("order.price"))+" : "+i(t.unitPrice)+" \u20AC ",1)]),_:2},1024)]),_:2},1024)]),_:2},1024),s<(((p=(u=e.order)==null?void 0:u.products)==null?void 0:p.length)||0)-1?($(),b(j,{key:0,spaced:""})):h("",!0)])}),128))]),_:1})])]}),_:1},8,["title"])}var ke=D(ge,[["render",he]]);const De=k({name:"OrdersPage",components:{OrderGrid:me,OrderConfirm:Qe,OrderDetail:ke},emits:[...le.emits],setup(){const{t:e}=z(),r=X(),a=_(!1),c=I(),m=de(),f=()=>{r.push({name:"neworder"})},l={id:"",providerId:"",reference:"",orderDate:new Date,storeId:"",products:[]},n=_(l);var t=_(null);const s=(E,S)=>{var q;try{((q=S==null?void 0:S.products)==null?void 0:q.length)===0&&c.loadOrderProducts(S.id),t.value=E;const P=c.orders.find(R=>R.id===S.id);if(!P)m.NotifyError(e("common.technicalError"));else{let R=Object.create(P);n.value=R}}catch{m.NotifyError(e("common.technicalError"))}},u=()=>{t.value=null,n.value=l};return{dialogOpened:a,editingRow:n,gotoNewOrder:f,sidePanel:t,openSidePanel:s,closeSidePanel:u,handleOrderConfirmed:()=>{u(),m.NotifySuccess(e("order.received"))},handleError:E=>{m.NotifyError(re(E))}}}});function Ee(e,r,a,c,m,f){const l=O("order-grid"),n=O("order-confirm"),t=O("order-detail");return $(),C(N,null,[o(G,null,{default:d(()=>[o(l,{onNewOrderClick:e.gotoNewOrder,onConfirmRowClick:r[0]||(r[0]=s=>e.openSidePanel("confirm",s)),onDetailRowClick:r[1]||(r[1]=s=>e.openSidePanel("detail",s))},null,8,["onNewOrderClick"])]),_:1}),o(A,{"model-value":e.sidePanel==="confirm",side:"right",bordered:""},{default:d(()=>[o(n,{"order-id":e.editingRow.id,modelValue:e.editingRow.products,"onUpdate:modelValue":r[2]||(r[2]=s=>e.editingRow.products=s),"order-reference":e.editingRow.reference,onOrderConfirmed:e.handleOrderConfirmed,onOrderConfirmError:e.handleError,onClose:e.closeSidePanel},null,8,["order-id","modelValue","order-reference","onOrderConfirmed","onOrderConfirmError","onClose"])]),_:1},8,["model-value"]),o(A,{"model-value":e.sidePanel==="detail",side:"right",bordered:""},{default:d(()=>[o(t,{modelValue:e.editingRow,"onUpdate:modelValue":r[3]||(r[3]=s=>e.editingRow=s),onClose:e.closeSidePanel},null,8,["modelValue","onClose"])]),_:1},8,["model-value"])],64)}var Fe=D(De,[["render",Ee]]);export{Fe as default};
