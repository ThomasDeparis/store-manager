import{Q as R}from"./QPage.5de83ca0.js";import{Q as L}from"./QDrawer.11c7cf11.js";import{d as N,c as S,w as A,o as B,r as v,_ as k,H as f,R as y,j as s,J as n,O,aj as j,Q as M,P as p,M as l,G as h,I as P,S as T,F as I,L as w,b3 as Y,K as G,N as U}from"./index.9f4750be.js";import{Q as F,a as H,S as z}from"./SidePanel.95ea8504.js";import{Q as J,a as K}from"./errortype.c2c282ff.js";import{u as V,h as W,a as X}from"./order-error-handler.3231cc46.js";import{u as q}from"./customer-store.7cd3fc73.js";import{u as Z}from"./user-store.9a7bf1de.js";import{u as E}from"./vue-i18n.runtime.77fe3db3.js";import{c as x,b as ee,Q as re,a as b}from"./QItem.a953653e.js";import{u as oe}from"./notify-handler.22bc6a9f.js";import{u as te}from"./use-dialog-plugin-component.0beb4358.js";import"./product-store.8720c5f0.js";import"./index.5d49afe9.js";const se=N({name:"SaleGrid",emits:["new-order-click","detail-row-click"],setup(){const{t:e}=E(),r=V(),d=Z(),i=q(),m=[{name:"actions",label:"",align:"center"},{name:"reference",label:e("order.reference"),field:"reference",sortable:!0},{name:"Customer",label:e("order.customer"),field:"customerName"},{name:"orderDate",label:e("order.orderDate"),field:"orderDate",sortable:!0,format:o=>W(o).format("DD/MM/YYYY")}],u=()=>{var o,c;(r.customerOrders==null||((o=r.customerOrders)==null?void 0:o.length)===0||r.storeId!==d.currentStore)&&r.loadCustomerOrders(d.currentStore),(i.customers==null||((c=i.customers)==null?void 0:c.length)===0||i.storeId!==d.currentStore)&&i.loadCustomers(d.currentStore)},t=S(()=>i.customers),a=S(()=>r.customerOrders.map(function(o){var c;return{...o,customerName:(c=t.value.find($=>$.id===o.customerId))==null?void 0:c.name,actions:null}}));return A(()=>d.currentStore,()=>{u()}),B(()=>{d.currentStore!=null&&u()}),{filter:v(""),columns:m,rows:a,loading:S(()=>r.isLoading)}}}),ae={class:"q-pa-md"},ne={class:"text-body2"};function le(e,r,d,i,m,u){return f(),y("div",ae,[s(K,{"grid-header":"",bordered:"",rows:e.rows,columns:e.columns,"row-key":"reference",filter:e.filter,"rows-per-page-options":[50,100]},{top:n(()=>[s(O,{color:"primary",label:e.$t("order.newSale"),onClick:r[0]||(r[0]=t=>e.$emit("new-order-click"))},null,8,["label"]),s(F),s(j,{dense:"",debounce:"300",color:"primary",modelValue:e.filter,"onUpdate:modelValue":r[1]||(r[1]=t=>e.filter=t)},{append:n(()=>[s(M,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-actions":n(t=>[s(J,{props:t},{default:n(()=>[s(O,{"data-testid":"detailorderbtn",class:"q-mr-sm",icon:"visibility",push:"",round:"",color:"primary",size:"sm",onClick:a=>e.$emit("detail-row-click",t.row)},{default:n(()=>[s(H,null,{default:n(()=>[p("div",ne,l(e.$t("buttons.detail")),1)]),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"])])}var de=k(se,[["render",le]]);const ie=N({name:"SaleDetail",components:{SidePanel:z},emits:["close"],props:{modelValue:{type:Object,required:!0}},setup(e){const r=S(()=>e.modelValue),d=q(),i=S(()=>{var u;return(u=d.customers.find(t=>t.id===r.value.customerId))==null?void 0:u.name}),m=S(()=>{var u,t;return(t=(u=r.value)==null?void 0:u.products)==null?void 0:t.reduce((a,o)=>a+o.unitPrice*((o==null?void 0:o.orderedQty)||0),0)});return{order:r,recipientName:i,totalAmount:m}}}),ue={class:"q-my-md q-mx-sm"},me={class:"q-ma-sm"},ce={class:"q-my-md"},pe={class:"row q-mx-sm"},fe={class:"row q-mx-sm text-caption"};function Se(e,r,d,i,m,u){const t=h("side-panel");return f(),P(t,{title:`D\xE9tail de la commande : ${e.order.reference}`,onClose:r[0]||(r[0]=a=>e.$emit("close"))},{default:n(()=>[p("div",null,[p("p",ue,l(e.$t("order.customer"))+" : "+l(e.recipientName),1),p("p",me,l(e.$t("order.orderDate"))+" : "+l(e.order.orderDate.toLocaleDateString()),1)]),p("div",ce,[p("span",pe,l(e.$t("order.totalAmount"))+" : "+l(e.totalAmount)+" \u20AC",1),p("span",fe,l(e.$t("order.cartContent")),1),s(x,{bordered:"",padding:""},{default:n(()=>[(f(!0),y(I,null,T(e.order.products,(a,o)=>{var c,$;return f(),y("div",{key:a.productId},[s(ee,null,{default:n(()=>[s(re,null,{default:n(()=>[s(b,{overline:""},{default:n(()=>[w(l(a.productReference),1)]),_:2},1024),s(b,{class:"q-mb-sm"},{default:n(()=>[w(l(a.productName),1)]),_:2},1024),s(b,{class:"row"},{default:n(()=>[w(l(e.$t("order.shortQty"))+" : "+l(a.orderedQty),1)]),_:2},1024),s(b,{class:"row"},{default:n(()=>[w(l(e.$t("order.price"))+" : "+l(a.unitPrice)+" \u20AC ",1)]),_:2},1024)]),_:2},1024)]),_:2},1024),o<((($=(c=e.order)==null?void 0:c.products)==null?void 0:$.length)||0)-1?(f(),P(Y,{key:0,spaced:""})):G("",!0)])}),128))]),_:1})])]),_:1},8,["title"])}var $e=k(ie,[["render",Se]]);const ge=N({name:"SalesPage",components:{SaleGrid:de,SaleDetail:$e},emits:[...te.emits],setup(){const{t:e}=E(),r=U(),d=v(!1),i=V(),m=oe(),u=()=>{r.push({name:"newsale"})},t={id:"",customerId:"",reference:"",orderDate:new Date,storeId:"",products:[]},a=v(t);var o=v(null);return{dialogOpened:d,editingRow:a,gotoNewOrder:u,sidePanel:o,openSidePanel:(Q,g)=>{var D;try{((D=g==null?void 0:g.products)==null?void 0:D.length)===0&&i.loadOrderProducts(g.id),o.value=Q;const C=i.customerOrders.find(_=>_.id===g.id);if(!C)m.NotifyError(e("common.technicalError"));else{let _=Object.create(C);a.value=_}}catch{m.NotifyError(e("common.technicalError"))}},closeSidePanel:()=>{o.value=null,a.value=t},handleError:Q=>{m.NotifyError(X(Q))}}}});function we(e,r,d,i,m,u){const t=h("sale-grid"),a=h("sale-detail");return f(),y(I,null,[s(R,null,{default:n(()=>[s(t,{onNewOrderClick:e.gotoNewOrder,onDetailRowClick:r[0]||(r[0]=o=>e.openSidePanel("detail",o))},null,8,["onNewOrderClick"])]),_:1}),s(L,{"model-value":e.sidePanel==="detail",side:"right",bordered:""},{default:n(()=>[s(a,{modelValue:e.editingRow,"onUpdate:modelValue":r[1]||(r[1]=o=>e.editingRow=o),onClose:e.closeSidePanel},null,8,["modelValue","onClose"])]),_:1},8,["model-value"])],64)}var Ee=k(ge,[["render",we]]);export{Ee as default};
